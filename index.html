<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#c49a6c">
  
  <!-- iOS PWA support -->
  
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Daruchini">
<link rel="apple-touch-icon" sizes="180x180" href="pwa-180x180.png">
	
  <!--------------------->

  <title>Daruchini Menu Ordering</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .tabs { display: flex; gap: 1rem; margin-bottom: 20px; }
    .tab { padding: 1rem 20px; background: #eee; cursor: pointer; border-radius: 5px; }
    .tab.active { background: #c49a6c; color: white; }
    .content { display: none; }
    .content.active { display: block; }
    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .menu-item { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px dashed #ddd; }
    .readonly { background: #f9f9f9; border: 1px solid #ccc; padding: 5px; margin-right: 8px; }
    .invoice-link { color: #0b5bd3; cursor: pointer; text-decoration: underline; }
    
    .manual-input {
      width: 60px;
      padding: 4px;
      margin-left: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }

    .filter-group {
      margin-bottom: 15px;
    }
    .filter-group label {
      margin-right: 15px;
      cursor: pointer;
    }
    
    .form-row {
      margin-bottom: 15px;   /* adds vertical space between rows */
    }

    .readonly {
      margin-right: 1rem;    /* adds horizontal space between inputs */
      padding: 5px;          /* internal padding inside the input */
    }



    /* Coin picker styles */
    .quantity-row { margin-top: 6px; }
    .coin-picker { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .coin {
      width: 36px; height: 36px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      background: #f0f0f0; border: 2px solid #d0d0d0; color: #333;
      cursor: pointer; user-select: none; font-weight: 600;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7), 0 1px 2px rgba(0,0,0,0.08);
      transition: transform 0.05s ease, border-color 0.1s ease, background 0.1s ease;
    }
    .coin:hover { transform: translateY(-1px); background: #e9e9e9; }
    .coin.selected {
      background: #ffe08a; border-color: #c49a6c; color: #5a3d1a;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.8), 0 0 0 2px rgba(196,154,108,0.25);
    }
    .coin.zero { opacity: 0.7; }
    .qty-label { font-weight: 600; }

    /* Pagination styles */
    .pagination { margin-top: 20px; text-align: center; }
    .pagination button { margin: 0 5px; padding: 5px 1rem; }
    .pagination span { margin: 0 1rem; }
  </style>
</head>
<body>

<h1>‡¶¶‡¶æ‡¶∞‡ßÅ‡¶ö‡¶ø‡¶®‡¶ø</h1>

<div class="tabs">
  <div class="tab active" onclick="showTab(0)">üìù Take Order</div>
  <div class="tab" onclick="showTab(1)">üìã View Orders</div>
  <div class="tab" onclick="showTab(2)">üßæ Invoice</div>
</div>




<!-- TAB 1 -->
<div class="content active" id="tab0">

    <div  style="background-color: #c48649; display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <h4 style="padding-left: 1rem;">Add Order Item</h4>
      <button type="button" onclick="newOrder()" style="padding-top: 1rem; padding-bottom: 1rem; padding-left: 1rem; padding-right: 1rem; margin-right: 1rem;  box-sizing: border-box;" >üîÑ New Order</button>     
    </div>

    <div class="form-row" style="margin-top: 8px;">
      <input type="text" id="selectedmenuItem" class="readonly" style="padding-top: 1rem; padding-bottom: 1rem; padding-left: 1.5rem; padding-right: 1.5rem; width: 7rem;" readonly>
      <input type="number" readonly min="1" max="100" id="addItemQtyInput" class="manual-input" style="padding-top: 1rem; padding-bottom: 1rem; padding-left: 1.5rem; padding-right: 2rem; width: 3rem;" value="0" />
    </div>
    <div id="selectItemForm" class="form-row">
      <div style="background: #f8efe6; height: 2rem; display: flex; justify-content: center; align-items: center;">
        <span>Select Item</span>
      </div>
      <div id="itemSerialCoins" class="coin-picker">
          <!-- Coins for serial numbers will be rendered dynamically -->
      </div>
      <div style="background: #f8efe6; margin-top: 8px; height: 2rem; display: flex; justify-content: center; align-items: center;">
        <span>Quantuty</span>
      </div>
      <div style="margin-top: 8px;">
        
        <div id="addItemQtyCoins" class="coin-picker">
          <!-- Coins 1-10 will render here -->
        </div>
      </div>

      <div style="margin-top: 8px; height: 3rem; background-color: #f8efe6; display: flex; justify-content: center; align-items: center;">
        <button type="button" id="addItemButton" style="box-sizing: border-box; height: 2rem; padding-left: 5rem; padding-right: 5rem;">Add Item</button>
      </div>


      <h4 style="background-color: #f1dac1; padding-top: 1rem; padding-bottom: 1rem; padding-left: 1rem;">Added Items</h4>

      <div id="addedItemsDisplay"></div>

      <form id="orderForm">

        <div  style="margin-top: 8px; background-color: #c48649; display: flex; justify-content: center;  width: 100%;">
          <input type="text" hidden="true" id="cancelConfirm" class="readonly" style=" padding-top: 1rem; padding-bottom: 1rem; padding-left: 1.5rem; padding-right: 1.5rem;">       
          <button id="orderSubmit" type="submit" style="margin-right: 1rem; padding-top: 1rem; padding-bottom: 1rem; padding-left: 1.5rem; padding-right: 1.5rem; box-sizing: border-box;">‚ûï Submit Order</button>
        </div>

        <div class="form-row" style="padding-top: 1rem;">
          <label>Order #</label>
          <input type="text" id="orderNo" class="readonly" style=" padding-top: 1rem; padding-bottom: 1rem; padding-left: 1.5rem; padding-right: 1.5rem;" readonly>       
        </div>

        <div class="form-row">
          <label>Time   </label>
          <input type="text" id="orderDate" class="readonly" style="width: 5rem; padding-top: 1rem; padding-bottom: 1rem; padding-left: 1rem; padding-right: 1rem;" readonly>
          <input type="text" id="orderTime" class="readonly" style="width: 5rem; padding-top: 1rem; padding-bottom: 1rem; padding-left: 1rem; padding-right: 1rem;" readonly>
        </div>
        
      </form>
      
    </div>

    
    <h4 style="background-color: #c48649; padding-top: 1rem; padding-bottom: 1rem; padding-left: 1rem;">Item List</h4>
    
    <div id="menuList"></div>
</div>

<!-- TAB 2 -->
<div class="content" id="tab1">
  <h2>Created Orders</h2>
  <div class="filter-group">
    <label><input type="radio" name="orderFilter" value="today" checked> Today</label>
    <label><input type="radio" name="orderFilter" value="yesterday"> Yesterday</label>
    <label><input type="radio" name="orderFilter" value="earlier"> Earlier</label>
  </div>
  <button onclick="exportOrdersPDF()">Export PDF</button>
  <div id="ordersDisplay"></div>
</div>



<!-- TAB 3 -->
<div class="content" id="tab2">
  <h2>Invoice</h2>
  <div id="invoiceDisplay"></div>
</div>

<script src="jspdf.umd.min.js"></script>

<script>
  if ("serviceWorker" in navigator) {
     navigator.serviceWorker.register("service-worker.js");
  }
</script>


<script>
const menuItems = [

  { id: 1, serial: 111, name: "‡¶™‡¶∞‡¶æ‡¶ü‡¶æ (morn)", inEnglish: "Parata", price: 10 },
  { id: 2, serial: 112, name: "‡¶™‡¶∞‡¶æ‡¶ü‡¶æ (eve)", inEnglish: "Parata", price: 20 },
  { id: 3, serial: 2, name: "‡¶§‡¶®‡ßç‡¶¶‡ßÅ‡¶∞‡¶ø", inEnglish: "Tanduri", price: 10 },
  { id: 4, serial: 131, name: "‡¶õ‡ßã‡¶≤‡¶æ‡¶∞ ‡¶°‡¶æ‡¶≤", inEnglish: "Daal", price: 20 },
  { id: 5, serial: 132, name: "‡¶™‡¶æ‡¶§‡¶≤‡¶æ ‡¶°‡¶æ‡¶≤", inEnglish: "Patla Daal", price: 10 },
  { id: 6, serial: 4, name: "‡¶∏‡¶¨‡¶ú‡¶ø", inEnglish: "Shabji", price: 20 },
  { id: 7, serial: 5, name: "‡¶ó‡¶ø‡¶≤‡¶æ ‡¶ï‡¶≤‡¶ø‡¶ú‡¶æ", inEnglish: "Gila Kalija", price: 60 },
  { id: 8, serial: 6, name: "‡¶®‡ßá‡¶π‡¶æ‡¶∞‡¶ø", inEnglish: "Nehari", price: 180 },


  { id: 9, serial: 7, name: "‡¶ñ‡¶ø‡¶ö‡ßÅ‡ßú‡¶ø", inEnglish: "Khichuri", price: 50 },
  { id: 10, serial: 8, name: "‡¶§‡ßá‡¶π‡¶æ‡¶∞‡¶ø", inEnglish: "Tehari", price: 120 },
  { id: 11, serial: 9, name: "‡¶°‡¶ø‡¶Æ ‡¶≠‡ßÅ‡¶®‡¶æ", inEnglish: "Dim Bhuna", price: 30 },
  { id: 12, serial: 10, name: "‡¶ó‡¶∞‡ßÅ", inEnglish: "Garu", price: 180 },
  { id: 13, serial: 111, name: "‡¶Æ‡ßÅ‡¶∞‡¶ó‡ßÄ (cock)", inEnglish: "Murgi", price: 100 },
  { id: 14, serial: 112, name: "‡¶Æ‡ßÅ‡¶∞‡¶ó‡ßÄ (broiler)", inEnglish: "Murgi", price: 70 },

  { id: 15, serial: 121, name: "‡¶∞‡ßã‡¶≤ (chicken)", inEnglish: "Roll", price: 30 },
  { id: 16, serial: 122, name: "‡¶∞‡ßã‡¶≤ (vegitable)", inEnglish: "Roll", price: 20 },
  { id: 17, serial: 13, name: "‡¶™‡ßÅ‡¶∞‡¶ø", inEnglish: "Puri", price: 10 },
  { id: 18, serial: 141, name: "‡¶∏‡¶ø‡¶ô‡¶æ‡¶∞‡¶æ", inEnglish: "Shigara", price: 10 },
  { id: 19, serial: 142, name: "‡¶ï‡¶≤‡¶ø‡¶ú‡¶æ ‡¶∏‡¶ø‡¶ô‡¶æ‡¶∞‡¶æ", inEnglish: "Kalija Shigara", price: 20 },
  { id: 20, serial: 15, name: "‡¶∏‡¶æ‡¶Æ‡ßÅ‡¶ö‡¶æ", inEnglish: "Samucha", price: 10 },


  { id: 21, serial: 16, name: "‡¶∏‡¶æ‡¶¶‡¶æ ‡¶≠‡¶æ‡¶§", inEnglish: "Shada Bhat", price: 15 },
  { id: 22, serial: 171, name: "‡¶Æ‡¶æ‡¶õ (rui)", inEnglish: "Maach", price: 100 },
  { id: 23, serial: 172, name: "‡¶Æ‡¶æ‡¶õ (koi)", inEnglish: "Maach", price: 60 },
  
  { id: 24, serial: 18, name: "‡¶ï‡¶∞‡¶≤‡¶æ", inEnglish: "Karalla", price: 30 },
  { id: 25, serial: 201, name: "‡¶≠‡¶∞‡ßç‡¶§‡¶æ (alu)", inEnglish: "Varta", price: 10 },
  { id: 26, serial: 202, name: "‡¶≠‡¶∞‡ßç‡¶§‡¶æ (maach)", inEnglish: "Varta", price: 30 },
  


  { id: 27, serial: 24, name: "‡¶ú‡¶ø‡¶≤‡¶æ‡¶™‡¶ø", inEnglish: "Jilapi", price: 220 },
  { id: 28, serial: 25, name: "‡¶∂‡¶∞‡ßç‡¶Æ‡¶æ", inEnglish: "Shawarma", price: 90 },
  { id: 29, serial: 26, name: "‡¶Æ‡¶Æ", inEnglish: "Momo", price: 100 },
  { id: 30, serial: 27, name: "‡¶ö‡¶æ‡¶â‡¶Æ‡¶ø‡¶®", inEnglish: "Chaumin", price: 50 },
  { id: 31, serial: 28, name: "‡¶™‡ßÅ‡¶°‡¶ø‡¶Ç", inEnglish: "Puding", price: 50 },

  { id: 32, serial: 29, name: "‡¶ó‡ßç‡¶∞‡¶ø‡¶≤", inEnglish: "Grill", price: 100 },
  { id: 33, serial: 30, name: "‡¶ö‡¶ø‡¶ï‡ßá‡¶® ‡¶ö‡¶æ‡¶™", inEnglish: "Chicken Chaap", price: 120 },
  { id: 34, serial: 33, name: "‡¶π‡¶æ‡¶≤‡¶ø‡¶Æ", inEnglish: "Momo", price: 100 },
  { id: 35, serial: 34, name: "Moglai", inEnglish: "Moglai", price: 80 },
  { id: 36, serial: 35, name: "Naan", inEnglish: "Naan", price: 25 }
  


];

let selectedInvoiceOrder = null;
let editingOrderSerial = null;
let currentPage = 1;
const itemsPerPage = 10;

var addedMenuItemsArr = [];

function showTab(index) {

  document.querySelectorAll('.tab').forEach((tab, i) => {
    tab.classList.toggle('active', i === index);
  });
  document.querySelectorAll('.content').forEach((content, i) => {
    content.classList.toggle('active', i === index);
  });
  if (index === 1) {
    cleanupOldOrders();
    renderOrders(currentPage);
  }
  if (index === 2) renderInvoice();
  if (index === 0 && editingOrderSerial) {
    loadOrderForEdit(editingOrderSerial);
    addedMenuItemsArr = [];
    menuItems.forEach(item => {
      const qty = parseInt(document.getElementById(`qty_${item.id}`).value || '0', 10);
      if (qty > 0) {
        addedMenuItemsArr.push({ ...item, quantity: qty });
      }
    });
    showAddedMenuItems();
  } else if(index === 0){
    
    addedMenuItemsArr = [];
    showAddedMenuItems();
	
	
  }
  
  if(index === 0){
	const ordrSbmt = document.getElementById('orderSubmit');
	if(editingOrderSerial == null){
		document.getElementById('cancelConfirm').hidden = true;
		ordrSbmt.innerHTML = "‚ûï Submit Order";
	} else {
		document.getElementById('cancelConfirm').hidden = false;
		ordrSbmt.innerHTML = "‚ûñ Cancel Order";
	}
  }
  
}

function renderMenu() {
  const container = document.getElementById('menuList');
  container.innerHTML = '';
  menuItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'menu-item';
    const coinRowId = `coin_${item.id}`;
    const hiddenInputId = `qty_${item.id}`;
    const manualInputId = `manual_${item.id}`;

    div.innerHTML = `
      <div><strong>${item.serial}. ${item.name}</strong> ‚Äî ‡ß≥${item.price}</div>
      <div class="quantity-row">
        <span class="qty-label">Quantity:</span>
        <input type="number" min="0" id="${manualInputId}" class="manual-input" value="0" />
        <div class="coin-picker" id="${coinRowId}">
          ${[...Array(21).keys()].map(i => `
            <div class="coin ${i===0 ? 'zero' : ''}" data-value="${i}">${i}</div>
          `).join('')}
        </div>
        
        <input type="hidden" name="${hiddenInputId}" id="${hiddenInputId}" value="0" />
      </div>
    `;
    container.appendChild(div);

    const coins = div.querySelectorAll('.coin');
    const manualInput = div.querySelector(`#${manualInputId}`);
    const hiddenInput = div.querySelector(`#${hiddenInputId}`);

    // coin click updates manual + hidden
    coins.forEach(coin => {
      coin.addEventListener('click', () => {
	    if(editingOrderSerial == null) {
			coins.forEach(c => c.classList.remove('selected'));
			coin.classList.add('selected');
			hiddenInput.value = coin.dataset.value;
			manualInput.value = coin.dataset.value;
		}        
      });
    });

    // manual input updates hidden + coin selection
    manualInput.addEventListener('input', () => {
	  if(editingOrderSerial == null){
		  const val = parseInt(manualInput.value || '0', 10);
		  hiddenInput.value = val;
		  coins.forEach(c => c.classList.remove('selected'));
		  const coinToSelect = Array.from(coins).find(c => parseInt(c.dataset.value) === val);
		  if (coinToSelect) coinToSelect.classList.add('selected');
	  }      
    });

    // default select 0
    //coins[0].classList.add('selected');
  });
}

function renderAddItemForm() {
  const serialContainer = document.getElementById('itemSerialCoins');
  const qtyContainer = document.getElementById('addItemQtyCoins');

  // Render serial coins
  serialContainer.innerHTML = menuItems.map(item => `
    <div class="coin" data-serial="${item.serial}">${item.serial}</div>
  `).join('');

  const qtyHTML = [...Array(20).keys()].map(i => `
    <div class="coin" data-value="${i+1}">${i+1}</div>
  `).join('');

  // Render quantity coins (1-20)
  qtyContainer.innerHTML =  '<div class="coin" data-value="0">0</div>' + qtyHTML;

  let selectedSerial = null;
  let selectedQty = 0;

  // Serial selection
  serialContainer.querySelectorAll('.coin').forEach(coin => {
    coin.addEventListener('click', () => {
		  if(editingOrderSerial == null){
			  serialContainer.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
			  coin.classList.add('selected');
			  selectedSerial = parseInt(coin.dataset.serial, 10);
			  const menuItem = menuItems.find(i => i.serial === selectedSerial);
			  document.getElementById('selectedmenuItem').value = menuItem ? menuItem.name : '';
			
		  }
      });
  });

  // Quantity selection
  qtyContainer.querySelectorAll('.coin').forEach(coin => {
    coin.addEventListener('click', () => {
		if(editingOrderSerial == null){
		  qtyContainer.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
		  coin.classList.add('selected');
		  selectedQty = parseInt(coin.dataset.value, 10);
		  document.getElementById('addItemQtyInput').value = selectedQty;
		}
    });
  });

  // Manual input updates coin selection
  const qtyInput = document.getElementById('addItemQtyInput');
  qtyInput.addEventListener('input', () => {
	if(editingOrderSerial == null){
		const val = parseInt(qtyInput.value || '1', 10);
		selectedQty = val;
		qtyContainer.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
		const coinToSelect = Array.from(qtyContainer.querySelectorAll('.coin'))
		  .find(c => parseInt(c.dataset.value) === val);
		if (coinToSelect) coinToSelect.classList.add('selected');
	}    
  });

  // Add Item button click
  document.getElementById('addItemButton').onclick = () => {
    if(editingOrderSerial == null){
		if (!selectedSerial) return alert("Please select Item SL#");
		if(selectedQty <= 0) return alert("Please select Quantity");
		const menuItem = menuItems.find(i => i.serial === selectedSerial);
		if (!menuItem) return alert("Invalid item selected");

		// Simulate quantity selection on menuList
		const hiddenInput = document.getElementById(`qty_${menuItem.id}`);
		hiddenInput.value = selectedQty;

		// Update coins visually
		const coinRow = document.getElementById(`coin_${menuItem.id}`);
		coinRow.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
		const coinToSelect = Array.from(coinRow.querySelectorAll('.coin'))
		  .find(c => parseInt(c.dataset.value) === selectedQty);
		if (coinToSelect) coinToSelect.classList.add('selected');

		// Reset add item form for next item
		serialContainer.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
		qtyContainer.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
		qtyContainer.querySelector('div[data-value="0"]').classList.add('selected');

		const alteredItem = addedMenuItemsArr.filter(itm => itm.id !== menuItem.id );
		
		const alterMenuItem = JSON.parse(JSON.stringify(menuItem)); 

		alterMenuItem.quantity = selectedQty;

		addedMenuItemsArr = [...alteredItem, alterMenuItem];

		qtyInput.value = 0;
		selectedSerial = null;
		selectedQty = 0;

		document.getElementById('selectedmenuItem').value = '';

		showAddedMenuItems();
	}
    
  };

  
}

function getNextOrder(now){
	  const nextDate = new Date(now);
	  nextDate.setDate(now.getDate() + 1);

	  const pad = n => n.toString().padStart(2, '0');
	  const datetimeStr = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}0000`;
	  
	  const nextDatetimeStr = `${nextDate.getFullYear()}${pad(nextDate.getMonth()+1)}${pad(nextDate.getDate())}0000`;
	  
	  const dateVal = parseInt(datetimeStr, 10);
	  
	  const nextDateVal = parseInt(nextDatetimeStr, 10);
	  
	  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
	  
	  const dayOrders = (orders.length <= 0) ? [dateVal] : orders.filter(itm => itm.serial > dateVal && itm.serial < nextDateVal).map(itm => itm.serial);
	  
	  const nextSerial = (dayOrders.length === 0) ? (dateVal + 1) : (Math.max(...dayOrders) + 1);
	  
	  return nextSerial;
}

function prepareOrderHeader() {
  
  const now = new Date();
  
  const nextSerial = getNextOrder(now);
  
  document.getElementById('orderNo').value = nextSerial;
  document.getElementById('orderDate').value = now.toLocaleDateString();
  document.getElementById('orderTime').value = now.toLocaleTimeString();
}

function saveOrder(e) {
	
	if(editingOrderSerial == null){	
	  e.preventDefault();
	  const selectedItems = [];
	  menuItems.forEach(item => {
		const qty = parseInt(document.getElementById(`qty_${item.id}`).value || '0', 10);
		if (qty > 0) {
		  selectedItems.push({ ...item, quantity: qty });
		}
	  });
	  if (selectedItems.length === 0) return alert("No items selected.");

	  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
	  const now = new Date();

	  if (editingOrderSerial) {
		const idx = orders.findIndex(o => o.serial === editingOrderSerial);
		if (idx >= 0) {
		  orders[idx] = {
			serial: editingOrderSerial,
			date: now.toLocaleDateString(),
			time: now.toLocaleTimeString(),
			items: selectedItems,
			isCanceled: true
		  };
		}
		selectedInvoiceOrder = editingOrderSerial;
		editingOrderSerial = null;
		showTab(1);
	  } else {
		const order = {
		  serial: getNextOrder(now),
		  date: now.toLocaleDateString(),
		  time: now.toLocaleTimeString(),
		  items: selectedItems
		};
		orders.push(order);
		selectedInvoiceOrder = order.serial;
	  }
	  localStorage.setItem('orders', JSON.stringify(orders));
	  showTab(2);
	
	} else {
		
		const confirmCancel = document.getElementById('cancelConfirm').value;
		
		if (confirmCancel && confirmCancel == 'cancel') {
		
			const orders = JSON.parse(localStorage.getItem('orders') || '[]');
			const otherOrders = orders.filter(itm => itm.serial !== editingOrderSerial);
			const cancelOrder = orders.find(itm => itm.serial === editingOrderSerial);
			if(cancelOrder){
			    cancelOrder.isCanceled = true;
				const allOrders = [...otherOrders, cancelOrder];
				localStorage.setItem('orders', JSON.stringify(allOrders));
				showTab(1);
			} else {
				alert("Order Not Found");
			}			
		  
		} else {
			alert("write cancel to calcel");
		}

	
	}

  
}

function renderOrders(page = 1) {
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  const container = document.getElementById('ordersDisplay');
  if (orders.length === 0) {
    container.innerHTML = "<p>No orders yet.</p>";
    return;
  }

  // get selected filter
  const filter = document.querySelector('input[name="orderFilter"]:checked').value;
  const todayStr = new Date().toLocaleDateString();
  const yesterdayStr = new Date(Date.now() - 86400000).toLocaleDateString();

  let filtered = orders.slice().reverse();
  if (filter === "today") {
    filtered = filtered.filter(o => o.date === todayStr);
  } else if (filter === "yesterday") {
    filtered = filtered.filter(o => o.date === yesterdayStr);
  } else if (filter === "earlier") {
    filtered = filtered.filter(o => o.date !== todayStr && o.date !== yesterdayStr);
  }

  if (filtered.length === 0) {
    container.innerHTML = "<p>No orders for this filter.</p>";
    return;
  }

  // üëâ Grand total across all filtered orders
  const grandTotal = filtered.reduce((sum, order) => {
    return sum + order.items.reduce((s, i) => s + i.price * i.quantity, 0);
  }, 0);
  
  const canceledTotal = filtered.filter(itm => itm.isCanceled).reduce((sum, order) => {
    return sum + order.items.reduce((s, i) => s + i.price * i.quantity, 0);
  }, 0);
  
  

  // pagination logic
  const totalPages = Math.ceil(filtered.length / itemsPerPage);
  currentPage = Math.min(Math.max(page, 1), totalPages);

  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedOrders = filtered.slice(start, end);



  // render orders
  const ordersHtml = paginatedOrders.map(order => {
    const total = order.items.reduce((sum, i) => sum + i.price * i.quantity, 0);
	if(order.isCanceled){
		return `<div style="margin-bottom: 12px;">
			<h3>Order #${order.serial} ‚Äî ${order.date} ${order.time} ... canceled</h3>
			<p>
			  Total: ‡ß≥${total}
			  ‚Äî <span class="invoice-link" onclick="viewInvoice(${order.serial})">View Invoice</span>
			</p>
		  </div>
		`;
	} else {
		return `
		  <div style="margin-bottom: 12px;">
			<h3>Order #${order.serial} ‚Äî ${order.date} ${order.time}</h3>
			<p>
			  Total: ‡ß≥${total}
			  ‚Äî <span class="invoice-link" onclick="viewInvoice(${order.serial})">View Invoice</span>
			</p>
		  </div>
		`;
	}
    
  }).join('');

  // pagination controls
  const paginationHtml = `
    <div class="pagination">
      <button onclick="renderOrders(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Prev</button>
      <span> Page ${currentPage} of ${totalPages} </span>
      <button onclick="renderOrders(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
    </div>
  `;

  // üëâ Show grand total above report
  container.innerHTML = `<h3>Grand Total: ‡ß≥${grandTotal - canceledTotal}</h3>` + `<h3>Canceled Total: ‡ß≥${canceledTotal}</h3>` + ordersHtml + paginationHtml;
}


// re-render when filter changes
document.querySelectorAll('input[name="orderFilter"]').forEach(radio => {
  radio.addEventListener('change', () => renderOrders(1));
});


function viewInvoice(serial) {
  selectedInvoiceOrder = serial;
  showTab(2);
}

function removeAddedMenuItem(removeItem){

  if(editingOrderSerial == null ) {
	  menuItems.filter(item => item.id === removeItem).forEach(item => {
		document.getElementById(`qty_${item.id}`).value = 0;
	  });
	  addedMenuItemsArr = addedMenuItemsArr.filter(itm => itm.id !== removeItem );
	  const coinRow = document.getElementById(`coin_${removeItem}`);
	  coinRow.querySelectorAll('.coin').forEach(c => c.classList.remove('selected'));
	  showAddedMenuItems();
  }

  
}

function showAddedMenuItems(){

  const total = addedMenuItemsArr.reduce((sum, itm) => {
      return sum + (itm.price * itm.quantity);  // Add the price * quantity for each item
  }, 0);

  if(addedMenuItemsArr.length <=0){
    document.getElementById('addedItemsDisplay').innerHTML = '';
  } else {

    document.getElementById('addedItemsDisplay').innerHTML = `
    <table>
      <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th></th></tr>
      ${addedMenuItemsArr.map(i => `
        <tr>
          <td> ${i.name}</td>
          <td>${i.quantity}</td>
          <td>${i.price}</td>
          <td>${i.price * i.quantity}</td>
          <td><input type="button" value="‚ùå" onclick="removeAddedMenuItem(${i.id})"></td>
        </tr>
      `).join('')}
      <tr><td colspan="3"><strong>Total</strong></td><td><strong>${total}</strong></td><td></td></tr>
    </table>
  `;

  }

  
}

function renderInvoice() {
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  if (orders.length === 0) {
    document.getElementById('invoiceDisplay').innerHTML = "<p>No orders yet.</p>";
    return;
  }
  const order = selectedInvoiceOrder
    ? orders.find(o => o.serial === selectedInvoiceOrder)
    : orders[orders.length - 1];
  if (!order) {
    document.getElementById('invoiceDisplay').innerHTML = "<p>Invoice not found.</p>";
    return;
  }
  const total = order.items.reduce((sum, i) => sum + i.price * i.quantity, 0);
  
  const ordr = (order.isCanceled) 
	? `Invoice for <b>Order #${order.serial}</b> .... canceled`
	: `Invoice for <b>Order #${order.serial}</b>`;
  
  document.getElementById('invoiceDisplay').innerHTML = `
    ${ordr}
    <p>Date: ${order.date} ‚Äî Time: ${order.time}</p>
    <table>
      <tr><th>Item</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>
      ${order.items.map(i => `
        <tr>
          <td> ${i.name}</td>
          <td>${i.quantity}</td>
          <td>‡ß≥${i.price}</td>
          <td>‡ß≥${i.price * i.quantity}</td>
        </tr>
      `).join('')}
      <tr><td colspan="3"><strong>Total</strong></td><td><strong>‡ß≥${total}</strong></td></tr>
    </table>
    <button onclick="cancelOrder(${order.serial})">Cancel Order</button>
  `;
}

function cancelOrder(orderSerial) {
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  const otherOrders = orders.filter(itm => itm.serial !== orderSerial);
  const order = orders.find(itm => itm.serial === orderSerial);
  if(order){
	  editingOrderSerial = order.serial;
	  showTab(0);
  } else {
	alert("Order Not Found");
  }
  
}

function loadOrderForEdit(serial) {
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  const order = orders.find(o => o.serial === serial);
  if (!order) return;

  // Fill header fields
  document.getElementById('orderNo').value = order.serial;
  document.getElementById('orderDate').value = order.date;
  document.getElementById('orderTime').value = order.time;

  // Reset menu
  renderMenu();

  // Fill coin selections
  order.items.forEach(item => {
    const qty = item.quantity;
    const hiddenInput = document.getElementById(`qty_${item.id}`);
    hiddenInput.value = qty;
    const coins = document.querySelectorAll(`#coin_${item.id} .coin`);
    coins.forEach(c => c.classList.remove('selected'));
    const coinToSelect = Array.from(coins).find(c => parseInt(c.dataset.value) === qty);
    if (coinToSelect) coinToSelect.classList.add('selected');
  });

  
}

async function exportOrdersPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  if (orders.length === 0) {
    alert("No orders to export.");
    return;
  }

  const filter = document.querySelector('input[name="orderFilter"]:checked').value;
  const todayStr = new Date().toLocaleDateString();
  const yesterdayStr = new Date(Date.now() - 86400000).toLocaleDateString();

  let filtered = orders.slice().reverse();
  if (filter === "today") {
    filtered = filtered.filter(o => o.date === todayStr);
  } else if (filter === "yesterday") {
    filtered = filtered.filter(o => o.date === yesterdayStr);
  } else if (filter === "earlier") {
    filtered = filtered.filter(o => o.date !== todayStr && o.date !== yesterdayStr);
  }

  if (filtered.length === 0) {
    alert("No orders found for this filter.");
    return;
  }

  // üëâ Grand total across filtered orders
  const grandTotal = filtered.reduce((sum, order) => {
    return sum + order.items.reduce((s, i) => s + i.price * i.quantity, 0);
  }, 0);
  
  const canceledTotal = filtered.filter(itm => itm.isCanceled).reduce((sum, order) => {
    return sum + order.items.reduce((s, i) => s + i.price * i.quantity, 0);
  }, 0);

  doc.setFontSize(14);
  doc.text(`Orders (${filter})`, 10, 10);
  doc.text(`Grand Total: ${grandTotal - canceledTotal}`, 10, 20);
  doc.text(`Canceled Order: ${canceledTotal}`, 10, 30);

  let y = 40;
  filtered.forEach(order => {
    doc.setFontSize(12);
    doc.text(`Order #${order.serial} ‚Äî ${order.date} ${order.time}`, 10, y);
    y += 6;
    order.items.forEach(item => {
      doc.text(`- ${item.inEnglish} x${item.quantity} @ ${item.price} = ${item.price * item.quantity}`, 15, y);
      y += 6;
    });
    const total = order.items.reduce((sum, i) => sum + i.price * i.quantity, 0);
    doc.text(`Total: ${total}`, 15, y);
    y += 10;

    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  });

  // --- Formatted timestamp YYYY-MM-DD-HH-MM-SS
  const now = new Date();
  const pad = n => n.toString().padStart(2, '0');
  const datetimeStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}-${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;


  doc.save(`orders_${filter}_${datetimeStr}.pdf`);
}

function cleanupOldOrders() {
  const orders = JSON.parse(localStorage.getItem('orders') || '[]');
  if (orders.length === 0) return;

  const todayStr = new Date().toLocaleDateString();
  const yesterdayStr = new Date(Date.now() - 86400000).toLocaleDateString();

  // Keep only orders from today, yesterday, or earlier day (2 days ago)
  const earlierStr = new Date(Date.now() - 2 * 86400000).toLocaleDateString();

  const filtered = orders.filter(o =>
    o.date === todayStr ||
    o.date === yesterdayStr ||
    o.date === earlierStr
  );

  localStorage.setItem('orders', JSON.stringify(filtered));
}

function newOrder() {

	  editingOrderSerial = null;
	  selectedInvoiceOrder = null;

	  document.getElementById('selectedmenuItem').value = '';

	  // regenerate order header
	  prepareOrderHeader();

	  // reset menu & quantities
	  renderMenu();

	  // switch to Take Order tab
	  showTab(0);
	  
}



// Initialize
document.getElementById('orderForm').addEventListener('submit', saveOrder);
renderMenu();
renderAddItemForm();
prepareOrderHeader();
</script>

</body>
</html>

